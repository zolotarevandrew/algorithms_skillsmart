До - функция получения компаний связанных с основной компанией, на определенном уровне.
По сути будет вызыватся в цикле камунды, до край 15 уровней.
Вызывать надо именно последовательно в цикле, поскольку после получения данных на каждом уровне, нужно идти в реестр по http за данными.
При получении данных компании из реестра, мы сразу сохраняем связь дочерней и родительской компании в метаданных.

После
Основная загвоздка - элементы списка ничего не знают о уровнях, поэтому приходилось рекурсивно их вычислять.
Самым простым решением кажется, определить новый рекурсивный тип выхода - "иерархия связанных компаний" (legal entity hierarchy).
 
"Выходом" будем считать - следующий уровень, поскольку первый всегда известен.

1. Когда выход будет пуст? Когда cписок компаний пуст.
2. Если выход не пуст, то какова его голова? Список компаний, прямо связанных с предыдущим уровнем.
3. Из каких данных рекурсивно строится хвост выхода? хвост строится "лениво" по запросу от начала головы.
   
В данном случае, думание в рамках результата, помогло выстроить правильный флоу работы с исходной структурой данных - компаниями.
И получить типизированную явную структуру выхода, смотря на которую, как раз таки легко понять, что происходит в программе - получение уровней иерархии компаний последовательно.

P.S - поскольку уровни увеличиваются от 1 до n. 
То можно прямо в камунду передавать список id текущего уровня и запрашивать явно по выделенному списку, без лишней фильтрации и рекурсии.